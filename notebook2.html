<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure Private Notebook ‚Äî Junaid</title>
  <style>
    :root{--bg1:#0f1724;--bg2:#071122;--accent:#00adb5;--danger:#ff004c}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto, sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#e6eef6}
    .card{width:96%;max-width:980px;background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));border-radius:14px;padding:18px;box-shadow:0 6px 30px rgba(0,0,0,0.6)}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    h1{font-size:1.1rem;margin:0}
    .row{display:flex;gap:12px}
    .col{flex:1}
    label{display:block;font-size:0.85rem;color:#bcd}
    input[type=password], input[type=text], textarea{width:100%;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:inherit}
    textarea{min-height:120px;resize:vertical}
    button{background:var(--accent);border:none;color:#002; padding:10px 12px;border-radius:8px;font-weight:600;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dff}
    button.danger{background:var(--danger);color:#fff}
    .hidden{display:none}
    #fileList{margin-top:10px;max-height:300px;overflow:auto;padding-right:6px}
    .fileItem{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(0,0,0,0.18)}
    .fileMeta{display:flex;gap:12px;align-items:center}
    .badge{font-size:0.8rem;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03)}
    footer{margin-top:12px;display:flex;justify-content:space-between;align-items:center}
    small.note{color:#9db3c8}
    .preview{margin-top:10px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
    a.link{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#00adb5"/><path d="M8 11v-1a4 4 0 118 0v1" stroke="#001" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>
        <h1>Secure Private Notebook</h1>
        <small class="note">Client-side encrypted vault ‚Äî files & notes encrypted in your browser. Password never leaves your device.</small>
      </div>
    </header>

    <!-- Login / Unlock -->
    <div id="unlockArea">
      <label>üîë Enter your password to unlock</label>
      <div style="display:flex;gap:10px;margin-top:8px">
        <input id="masterPassword" type="password" placeholder="Choose a strong password (remember it)" autocomplete="new-password">
        <button id="unlockBtn">Unlock</button>
      </div>
      <p style="margin-top:8px"><small class="note">This app uses modern Web Crypto (PBKDF2 + AES-GCM). If you forget the password your files cannot be recovered.</small></p>
    </div>

    <!-- App UI -->
    <div id="appArea" class="hidden">
      <div class="row">
        <div class="col" style="min-width:320px;">
          <label>üìù Secure Notes</label>
          <textarea id="secureNotes" placeholder="Write private notes here... (will be encrypted)"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="saveNotes">Save Notes</button>
            <button id="clearNotes" class="secondary">Clear</button>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

          <label>üìÇ Upload & Encrypt Files</label>
          <input id="fileInput" type="file" multiple>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addFiles">Encrypt & Add</button>
            <button id="exportBackup" class="secondary">Export Backup</button>
            <button id="importBackup" class="secondary">Import Backup</button>
          </div>

          <div id="fileList"></div>
        </div>

        <div class="col" style="max-width:420px;">
          <label>üîç Preview / Actions</label>
          <div id="preview" class="preview">Select a file to preview or download after unlocking it.</div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

          <div style="display:flex;gap:8px;align-items:center">
            <button id="logoutBtn" class="danger">Lock & Logout</button>
            <small class="note">Your session key is kept in memory and cleared on logout/close. Files remain encrypted in browser storage.</small>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <small class="note">Made for Junaid ‚Äî client-side only. Not a backup substitute.</small>
      <small><a class="link" href="#" id="helpToggle">Help</a></small>
    </footer>

    <div id="help" class="hidden" style="margin-top:12px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px">
      <h4 style="margin:6px 0">How it works</h4>
      <ul>
        <li>We derive a cryptographic key from your password using PBKDF2 (stored salt per file).</li>
        <li>Files are encrypted with AES-GCM and saved to your browser (IndexedDB) in ciphertext form.</li>
        <li>To view or download, the correct password is required to derive the key and decrypt the data locally.</li>
        <li><strong>If you forget the password, files are unrecoverable.</strong></li>
      </ul>
    </div>
  </div>

  <script>
    // ---------------------- Utilities ----------------------
    const bufToB64 = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
    const b64ToBuf = b64 => Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    const randBytes = len => { const a = new Uint8Array(len); crypto.getRandomValues(a); return a; };

    // ---------------------- IndexedDB wrapper ----------------------
    const DB_NAME = 'secure-notebook-db';
    const STORE = 'files';
    let dbPromise = null;
    function openDB(){
      if(dbPromise) return dbPromise;
      dbPromise = new Promise((res,rej)=>{
        const r = indexedDB.open(DB_NAME,1);
        r.onupgradeneeded = e => { const db = e.target.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE, {keyPath:'id', autoIncrement:true}); };
        r.onsuccess = e => res(e.target.result);
        r.onerror = e => rej(e.target.error);
      });
      return dbPromise;
    }
    async function idbPut(obj){ const db = await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(STORE,'readwrite'); const s = tx.objectStore(STORE); const r = s.add(obj); r.onsuccess = () => res(r.result); r.onerror = e=>rej(e); }); }
    async function idbGetAll(){ const db = await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(STORE,'readonly'); const s = tx.objectStore(STORE); const r = s.getAll(); r.onsuccess = ()=>res(r.result); r.onerror=e=>rej(e); }); }
    async function idbDelete(id){ const db = await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(STORE,'readwrite'); const s = tx.objectStore(STORE); const r = s.delete(id); r.onsuccess = ()=>res(); r.onerror=e=>rej(e); }); }
    async function idbClearAll(){ const db = await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(STORE,'readwrite'); const s = tx.objectStore(STORE); const r = s.clear(); r.onsuccess = ()=>res(); r.onerror=e=>rej(e); }); }

    // ---------------------- Crypto functions (Web Crypto API) ----------------------
    async function deriveKey(password, salt){
      const enc = new TextEncoder();
      const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
      return crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations: 190000, hash:'SHA-256'}, baseKey, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
    }

    async function encryptArrayBuffer(key, plainBuffer){
      const iv = randBytes(12);
      const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, plainBuffer);
      return {iv, cipher};
    }

    async function decryptArrayBuffer(key, iv, cipherBuffer){
      return crypto.subtle.decrypt({name:'AES-GCM', iv}, key, cipherBuffer);
    }

    // ---------------------- App State ----------------------
    let masterKey = null; // CryptoKey kept in memory for session
    let currentPassword = null; // plaintext only in memory while session active

    // ---------------------- UI Elements ----------------------
    const unlockArea = document.getElementById('unlockArea');
    const appArea = document.getElementById('appArea');
    const masterPasswordInput = document.getElementById('masterPassword');
    const unlockBtn = document.getElementById('unlockBtn');
    const secureNotes = document.getElementById('secureNotes');
    const saveNotesBtn = document.getElementById('saveNotes');
    const clearNotesBtn = document.getElementById('clearNotes');
    const fileInput = document.getElementById('fileInput');
    const addFilesBtn = document.getElementById('addFiles');
    const fileList = document.getElementById('fileList');
    const preview = document.getElementById('preview');
    const logoutBtn = document.getElementById('logoutBtn');
    const exportBackupBtn = document.getElementById('exportBackup');
    const importBackupBtn = document.getElementById('importBackup');
    const helpToggle = document.getElementById('helpToggle');

    helpToggle.addEventListener('click', e=>{ e.preventDefault(); document.getElementById('help').classList.toggle('hidden'); });

    // ---------------------- Unlock / Lock Flow ----------------------
    unlockBtn.addEventListener('click', async ()=>{
      const pw = masterPasswordInput.value.trim();
      if(!pw){ alert('Enter a password'); return; }
      currentPassword = pw;
      // We don't derive a single static key ‚Äî we derive per-file with stored salt when decrypting.
      // But for convenience we store a session key derived from a global salt stored in localStorage to speed notes encryption.
      try{
        masterKey = await deriveSessionKey(pw);
        unlockArea.classList.add('hidden'); appArea.classList.remove('hidden');
        await loadNotesFromStore();
        await refreshFileList();
        masterPasswordInput.value = '';
      }catch(err){ console.error(err); alert('Failed to derive key ‚Äî your browser might not support required crypto.'); }
    });

    logoutBtn.addEventListener('click', ()=>{ // clear session
      masterKey = null; currentPassword = null; secureNotes.value = '';
      appArea.classList.add('hidden'); unlockArea.classList.remove('hidden'); preview.innerHTML = 'Locked. Enter password to unlock.';
    });

    // ---------------------- Session key for notes ----------------------
    // We'll keep a single global salt for notes in localStorage so notes are decryptable with the same password.
    function ensureNotesSalt(){ let s = localStorage.getItem('notes_salt'); if(!s){ s = bufToB64(randBytes(16)); localStorage.setItem('notes_salt', s); } return b64ToBuf(s); }
    async function deriveSessionKey(password){ const salt = ensureNotesSalt(); return deriveKey(password, salt); }

    // ---------------------- Notes storage ----------------------
    saveNotesBtn.addEventListener('click', async ()=>{
      if(!masterKey){ alert('Unlock first'); return; }
      const text = secureNotes.value || '';
      const enc = new TextEncoder();
      const {iv, cipher} = await encryptArrayBuffer(masterKey, enc.encode(text));
      localStorage.setItem('notes_cipher', bufToB64(cipher));
      localStorage.setItem('notes_iv', bufToB64(iv));
      alert('‚úÖ Notes encrypted & saved locally');
    });

    clearNotesBtn.addEventListener('click', ()=>{ if(confirm('Clear saved notes?')){ localStorage.removeItem('notes_cipher'); localStorage.removeItem('notes_iv'); secureNotes.value=''; } });

    async function loadNotesFromStore(){ try{
      const c = localStorage.getItem('notes_cipher'); const ivb = localStorage.getItem('notes_iv');
      if(c && ivb && masterKey){ const plain = await decryptArrayBuffer(masterKey, b64ToBuf(ivb), b64ToBuf(c)); secureNotes.value = new TextDecoder().decode(plain); }
    }catch(e){ console.warn('Unable to load notes ‚Äî maybe wrong password for notes.'); }
    }

    // ---------------------- File add / encrypt ----------------------
    addFilesBtn.addEventListener('click', async ()=>{
      if(!currentPassword){ alert('Unlock first'); return; }
      const files = fileInput.files; if(!files.length){ alert('Pick files'); return; }
      for(const f of files){
        const buffer = await f.arrayBuffer();
        const salt = randBytes(16);
        const key = await deriveKey(currentPassword, salt);
        const {iv, cipher} = await encryptArrayBuffer(key, buffer);
        const record = { name: f.name, type: f.type || 'application/octet-stream', iv: bufToB64(iv), salt: bufToB64(salt), data: bufToB64(cipher), createdAt: Date.now() };
        await idbPut(record);
      }
      fileInput.value = '';
      await refreshFileList();
      alert('‚úÖ Files encrypted & saved locally');
    });

    // ---------------------- File list & actions ----------------------
    async function refreshFileList(){
      const list = await idbGetAll();
      fileList.innerHTML = list.length ? list.map(it=>`
        <div class="fileItem">
          <div class="fileMeta">
            <div>
              <div style="font-weight:600">${escapeHtml(it.name)}</div>
              <div style="font-size:0.8rem;color:#9db3c8">${new Date(it.createdAt).toLocaleString()}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button onclick="previewFile(${it.id})">Preview</button>
            <button onclick="downloadFile(${it.id})" class="secondary">Download</button>
            <button onclick="deleteFile(${it.id})" class="danger">Delete</button>
          </div>
        </div>
      `).join('') : '<div class="note" style="padding:8px;color:#9db3c8">No files yet</div>';
      fileList.querySelectorAll('button').forEach(b=>b.addEventListener('click', e=>e.stopPropagation()));
    }

    // helper to escape HTML
    function escapeHtml(s){ return (s+'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

    // Expose functions used by generated buttons (they're created as strings above)
    window.previewFile = async function(id){
      if(!currentPassword) { alert('Unlock first'); return; }
      const all = await idbGetAll(); const it = all.find(x=>x.id===id); if(!it){ alert('File not found'); return; }
      try{
        const salt = b64ToBuf(it.salt); const iv = b64ToBuf(it.iv); const cipher = b64ToBuf(it.data);
        const key = await deriveKey(currentPassword, salt);
        const plainBuf = await decryptArrayBuffer(key, iv, cipher);
        const blob = new Blob([plainBuf], {type: it.type});
        const url = URL.createObjectURL(blob);
        // show appropriate preview
        let html = `<div style="display:flex;gap:8px;flex-direction:column">`;
        if(it.type.startsWith('image/')) html += `<img src="${url}" style="max-width:100%;border-radius:8px">`;
        else if(it.type.startsWith('video/')) html += `<video src="${url}" controls style="max-width:100%;border-radius:8px"></video>`;
        else if(it.type.startsWith('audio/')) html += `<audio src="${url}" controls></audio>`;
        else if(it.type=== 'text/plain' || it.type.startsWith('text/')){
          const text = new TextDecoder().decode(plainBuf);
          html += `<pre style="white-space:pre-wrap;max-height:300px;overflow:auto">${escapeHtml(text)}</pre>`;
        } else {
          html += `<div style="padding:8px">No preview available for this file type. Use Download.</div>`;
        }
        html += `<div style="display:flex;gap:8px;margin-top:8px"><a id="dlLink" href="${url}" download="${encodeURIComponent(it.name)}" class="link">Download Decrypted</a><button onclick="revoke('${url}')" class="secondary">Close Preview</button></div></div>`;
        preview.innerHTML = html;
      }catch(e){ console.error(e); alert('Unable to decrypt file. Is your password correct?'); }
    };

    window.revoke = function(url){ try{ URL.revokeObjectURL(url); preview.innerHTML = 'Preview closed.'; }catch(e){} };

    window.downloadFile = async function(id){
      if(!currentPassword) { alert('Unlock first'); return; }
      const all = await idbGetAll(); const it = all.find(x=>x.id===id); if(!it){ alert('File not found'); return; }
      try{
        const salt = b64ToBuf(it.salt); const iv = b64ToBuf(it.iv); const cipher = b64ToBuf(it.data);
        const key = await deriveKey(currentPassword, salt);
        const plainBuf = await decryptArrayBuffer(key, iv, cipher);
        const blob = new Blob([plainBuf], {type: it.type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = it.name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 2000);
      }catch(e){ console.error(e); alert('Unable to decrypt file. Is your password correct?'); }
    };

    window.deleteFile = async function(id){ if(!confirm('Delete this file permanently?')) return; await idbDelete(id); await refreshFileList(); preview.innerHTML=''; };

    // ---------------------- Backup / Restore ----------------------
    exportBackupBtn.addEventListener('click', async ()=>{
      const list = await idbGetAll(); const notesCipher = localStorage.getItem('notes_cipher'); const notesIv = localStorage.getItem('notes_iv'); const notesSalt = localStorage.getItem('notes_salt');
      const payload = { files: list, notes: { cipher: notesCipher, iv: notesIv, salt: notesSalt } };
      const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'secure-notebook-backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000);
    });

    importBackupBtn.addEventListener('click', ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange = async e=>{
        const f = e.target.files[0]; if(!f) return; const text = await f.text(); try{ const obj = JSON.parse(text); if(obj.files && Array.isArray(obj.files)){ await idbClearAll(); for(const it of obj.files){ await idbPut(it); } if(obj.notes) { localStorage.setItem('notes_cipher', obj.notes.cipher||''); localStorage.setItem('notes_iv', obj.notes.iv||''); localStorage.setItem('notes_salt', obj.notes.salt||''); }
            alert('Backup imported'); await refreshFileList(); } else alert('Invalid backup file'); }catch(err){ alert('Invalid JSON'); }
      };
      inp.click();
    });

    // Initialize preview text
    preview.innerHTML = 'Locked. Enter password to unlock.';

    // On load, but keep locked
    (async ()=>{
      await openDB(); // ensure DB ready
    })();

    // Security note shown to user
    console.log('Secure Notebook loaded. Remember: this is client-side encryption ‚Äî keep your password safe.');
  </script>
</body>
</html>
